<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Task Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box;font-family:"Work Sans",sans-serif}
body{margin:0;background:#f6fbfa;padding:20px}

.dashboard{display:flex;gap:14px;flex-wrap:wrap;margin-bottom:20px}
.card{flex:1;background:#fff;padding:14px;border-radius:14px;text-align:center;box-shadow:0 2px 6px rgba(0,0,0,.08)}
.card h2{margin:0;font-size:26px}
.card p{margin:4px 0 0;color:#666;font-size:14px}

.form-box{background:#fff;padding:16px;border-radius:14px;margin-bottom:16px;box-shadow:0 2px 6px rgba(0,0,0,.08)}
.form-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}

input,textarea,select{
  padding:8px 10px;border-radius:10px;border:1px solid #ccc;font-size:14px
}
textarea{resize:vertical}

button{
  margin-top:12px;padding:10px 18px;border-radius:12px;
  border:none;background:#4db6ac;color:#fff;cursor:pointer
}
button.secondary{background:#90a4ae}

table{
  width:100%;background:#fff;border-radius:14px;overflow:hidden;
  box-shadow:0 2px 6px rgba(0,0,0,.08)
}
th,td{padding:10px;border-bottom:1px solid #eee}
th{background:#e0f2f1}

.thumbnail{
  width:56px;height:56px;border-radius:8px;
  object-fit:cover;cursor:pointer;margin:4px
}

.badge{padding:4px 10px;border-radius:999px;font-size:12px;color:#fff}
.todo{background:#90a4ae}
.progress{background:#42a5f5}
.blocked{background:#ef5350}
.done{background:#66bb6a}
.reopen{background:#ffa726}

.action-btn{cursor:pointer;color:#00796b;font-weight:500}

#imageModal{
  display:none;position:fixed;inset:0;
  background:rgba(0,0,0,.7);
  justify-content:center;align-items:center
}
#imageModal img{max-width:80%;max-height:80%;border-radius:16px}
#imageModal span{
  position:absolute;top:20px;right:30px;
  color:#fff;font-size:32px;cursor:pointer
}
</style>
</head>

<body>

<!-- DASHBOARD -->
<div class="dashboard">
  <div class="card"><h2 id="total">0</h2><p>Total</p></div>
  <div class="card"><h2 id="todo">0</h2><p>To Do</p></div>
  <div class="card"><h2 id="progress">0</h2><p>Progress</p></div>
  <div class="card"><h2 id="blocked">0</h2><p>Blocked</p></div>
  <div class="card"><h2 id="done">0</h2><p>Done</p></div>
  <div class="card"><h2 id="reopen">0</h2><p>Reopen</p></div>
</div>

<!-- FORM -->
<div class="form-box">
<h3 id="formTitle">Tambah Task</h3>
<div class="form-grid">
  <textarea id="desc" placeholder="Deskripsi"></textarea>

  <select id="type">
    <option value="Task">Task</option>
    <option value="Kendala">Kendala</option>
  </select>

  <select id="status">
    <option value="To Do">To Do</option>
    <option value="Progress">Progress</option>
    <option value="Blocked">Blocked</option>
    <option value="Done">Done</option>
    <option value="Reopen">Reopen</option>
  </select>

  <input id="dev" placeholder="Pengembang">
  <textarea id="solution" placeholder="Solusi (wajib jika Done)"></textarea>
  <input type="file" id="images" multiple accept="image/*">
</div>

<button type="button" onclick="submitTask()">Simpan</button>
<button type="button" id="cancelBtn" class="secondary" onclick="cancelEdit()" style="display:none">Batal</button>
</div>

<!-- TABLE -->
<table>
<thead>
<tr>
  <th>Deskripsi</th>
  <th>Type</th>
  <th>Status</th>
  <th>Pengembang</th>
  <th>Solusi</th>
  <th>Gambar</th>
  <th>Aksi</th>
</tr>
</thead>
<tbody id="taskBody"></tbody>
</table>

<!-- MODAL -->
<div id="imageModal" onclick="closeModal()">
  <span>&times;</span>
  <img id="modalImg">
</div>

<script type="module">
/* ================= FIREBASE ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs,
  query, orderBy, serverTimestamp,
  updateDoc, deleteDoc, doc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ================= CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyBwc0ZetyNIhxc-tXnpC9aIVzguRmc29h8",
  authDomain: "pilarb3.firebaseapp.com",
  projectId: "pilarb3"
};

const CLOUD_NAME = "dq3ctvi3r";
const UPLOAD_PRESET = "task_dashboard";

/* ================= INIT ================= */
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ================= ELEMENT ================= */
const descEl = document.getElementById("desc");
const typeEl = document.getElementById("type");
const statusEl = document.getElementById("status");
const devEl = document.getElementById("dev");
const solutionEl = document.getElementById("solution");
const imagesEl = document.getElementById("images");

let tasks = [];
let editIndex = null;

/* ================= CLOUDINARY ================= */
async function uploadToCloudinary(file){
  const fd = new FormData();
  fd.append("file", file);
  fd.append("upload_preset", UPLOAD_PRESET);

  const res = await fetch(
    `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`,
    { method:"POST", body: fd }
  );

  const data = await res.json();
  return data.secure_url;
}

/* ================= FIRESTORE ================= */
async function loadTasks(){
  tasks=[];
  const q=query(collection(db,"tasks"),orderBy("createdAt","desc"));
  const snap=await getDocs(q);
  snap.forEach(d=>tasks.push({id:d.id,...d.data()}));
  render();
}

window.submitTask = async () => {
  if(statusEl.value==="Done" && !solutionEl.value.trim()){
    alert("Solusi wajib diisi jika Done");
    return;
  }

  const imageUrls=[];
  for(const f of imagesEl.files){
    imageUrls.push(await uploadToCloudinary(f));
  }

  const data={
    desc:descEl.value,
    type:typeEl.value,
    status:statusEl.value,
    dev:devEl.value,
    solution:solutionEl.value,
    images:imageUrls,
    createdAt:serverTimestamp()
  };

  if(editIndex!==null){
    await updateDoc(doc(db,"tasks",tasks[editIndex].id),data);
  } else {
    await addDoc(collection(db,"tasks"),data);
  }

  resetForm();
  loadTasks();
};

window.deleteTask = async (i)=>{
  if(confirm("Hapus task?")){
    await deleteDoc(doc(db,"tasks",tasks[i].id));
    loadTasks();
  }
};

window.editTask = (i)=>{
  const t=tasks[i];
  descEl.value=t.desc;
  typeEl.value=t.type;
  statusEl.value=t.status;
  devEl.value=t.dev;
  solutionEl.value=t.solution || "";
  editIndex=i;
  cancelBtn.style.display="inline";
};

window.cancelEdit = ()=>resetForm();

function resetForm(){
  descEl.value="";
  devEl.value="";
  solutionEl.value="";
  imagesEl.value="";
  editIndex=null;
  cancelBtn.style.display="none";
}

function badge(s){
  return `<span class="badge ${s.replace(" ","").toLowerCase()}">${s}</span>`;
}

function render(){
  taskBody.innerHTML="";
  tasks.forEach((t,i)=>{
    taskBody.innerHTML+=`
      <tr>
        <td>${t.desc}</td>
        <td>${t.type}</td>
        <td>${badge(t.status)}</td>
        <td>${t.dev}</td>
        <td>${t.solution||"â€”"}</td>
        <td>
          ${t.images.map(img=>`<img src="${img}" class="thumbnail" onclick="openModal('${img}')">`).join("")}
        </td>
        <td>
          <span class="action-btn" onclick="editTask(${i})">Edit</span> |
          <span class="action-btn" onclick="deleteTask(${i})">Delete</span>
        </td>
      </tr>
    `;
  });

  total.innerText=tasks.length;
  todo.innerText=tasks.filter(t=>t.status==="To Do").length;
  progress.innerText=tasks.filter(t=>t.status==="Progress").length;
  blocked.innerText=tasks.filter(t=>t.status==="Blocked").length;
  done.innerText=tasks.filter(t=>t.status==="Done").length;
  reopen.innerText=tasks.filter(t=>t.status==="Reopen").length;
}

window.openModal = (src)=>{
  modalImg.src=src;
  imageModal.style.display="flex";
};
window.closeModal = ()=>imageModal.style.display="none";

loadTasks();
</script>

</body>
</html>
