<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Task Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600&display=swap" rel="stylesheet">

<style>
* { box-sizing:border-box; font-family:"Work Sans",sans-serif }
body { margin:0; background:#f6fbfa; padding:20px }

.dashboard{display:flex;gap:14px;flex-wrap:wrap;margin-bottom:20px}
.card{flex:1;background:#fff;padding:14px;border-radius:14px;text-align:center;box-shadow:0 2px 6px rgba(0,0,0,.08)}
.card h2{margin:0;font-size:26px}
.card p{margin:4px 0 0;color:#666;font-size:14px}

.form-box{background:#fff;padding:16px;border-radius:14px;margin-bottom:16px;box-shadow:0 2px 6px rgba(0,0,0,.08)}
.form-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
input,textarea,select{padding:8px 10px;border-radius:10px;border:1px solid #ccc;font-size:14px}
textarea{resize:vertical}
button{margin-top:12px;padding:10px 18px;border-radius:12px;border:none;background:#4db6ac;color:#fff;cursor:pointer}
button.secondary{background:#90a4ae}

table{width:100%;background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,.08)}
th,td{padding:10px;border-bottom:1px solid #eee}
th{background:#e0f2f1}
.thumbnail{width:56px;height:56px;border-radius:8px;object-fit:cover;cursor:pointer;margin:4px}

.badge{padding:4px 10px;border-radius:999px;font-size:12px;color:#fff}
.todo{background:#90a4ae}.progress{background:#42a5f5}
.blocked{background:#ef5350}.done{background:#66bb6a}.reopen{background:#ffa726}

.action-btn{cursor:pointer;color:#00796b;font-weight:500}

#imageModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);justify-content:center;align-items:center}
#imageModal img{max-width:80%;max-height:80%;border-radius:16px}
#imageModal span{position:absolute;top:20px;right:30px;color:#fff;font-size:32px;cursor:pointer}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginBox" class="form-box">
  <h3>Login</h3>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
  <button class="secondary" onclick="register()">Register</button>
</div>

<!-- APP -->
<div id="app" style="display:none;">
<button onclick="logout()">Logout</button>

<div class="dashboard">
  <div class="card"><h2 id="total">0</h2><p>Total</p></div>
  <div class="card"><h2 id="todo">0</h2><p>To Do</p></div>
  <div class="card"><h2 id="progress">0</h2><p>Progress</p></div>
  <div class="card"><h2 id="blocked">0</h2><p>Blocked</p></div>
  <div class="card"><h2 id="done">0</h2><p>Done</p></div>
  <div class="card"><h2 id="reopen">0</h2><p>Reopen</p></div>
</div>

<div class="form-box">
<h3 id="formTitle">Tambah Task</h3>
<div class="form-grid">
<textarea id="desc" placeholder="Deskripsi"></textarea>
<select id="type"><option>Task</option><option>Kendala</option></select>
<select id="status">
<option>To Do</option><option>Progress</option>
<option>Blocked</option><option>Done</option><option>Reopen</option>
</select>
<input id="dev" placeholder="Pengembang">
<textarea id="solution" placeholder="Solusi (wajib jika Done)"></textarea>
<input id="imageUrls" placeholder="Link gambar (pisahkan koma)">
</div>
<button onclick="submitTask()">Simpan</button>
<button id="cancelBtn" class="secondary" onclick="cancelEdit()" style="display:none">Batal</button>
</div>

<table>
<thead>
<tr><th>Deskripsi</th><th>Type</th><th>Status</th><th>Dev</th><th>Solusi</th><th>Gambar</th><th>Aksi</th></tr>
</thead>
<tbody id="taskBody"></tbody>
</table>
</div>

<div id="imageModal" onclick="closeModal()">
<span>&times;</span><img id="modalImg">
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBwc0ZetyNIhxc-tXnpC9aIVzguRmc29h8",
  authDomain: "pilarb3.firebaseapp.com",
  projectId: "pilarb3"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser=null, tasks=[], editIndex=null;

window.login=()=>signInWithEmailAndPassword(auth,email.value,password.value);
window.register=()=>createUserWithEmailAndPassword(auth,email.value,password.value);
window.logout=()=>signOut(auth);

onAuthStateChanged(auth, u => {
  if (u) {
    currentUser = u.uid;
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("app").style.display = "block";
    loadTasks();
  } else {
    document.getElementById("loginBox").style.display = "block";
    document.getElementById("app").style.display = "none";
  }
});
async function loadTasks(){
  tasks=[];
  const q=query(collection(db,"users",currentUser,"tasks"),orderBy("createdAt","desc"));
  const snap=await getDocs(q);
  snap.forEach(d=>tasks.push({id:d.id,...d.data()}));
  render();
}

window.submitTask=async()=>{
  if(status.value==="Done"&&!solution.value.trim())return alert("Solusi wajib");
  const images=imageUrls.value.split(",").map(v=>v.trim()).filter(v=>v);
  const data={desc:desc.value,type:type.value,status:status.value,dev:dev.value,solution:solution.value,images,createdAt:serverTimestamp()};
  if(editIndex!=null){
    await updateDoc(doc(db,"users",currentUser,"tasks",tasks[editIndex].id),data);
  }else{
    await addDoc(collection(db,"users",currentUser,"tasks"),data);
  }
  resetForm(); loadTasks();
};

window.deleteTask=async i=>{
  if(confirm("Hapus task?")){await deleteDoc(doc(db,"users",currentUser,"tasks",tasks[i].id));loadTasks();}
};

window.editTask=i=>{
  const t=tasks[i]; desc.value=t.desc; type.value=t.type; status.value=t.status;
  dev.value=t.dev; solution.value=t.solution; imageUrls.value=t.images.join(",");
  editIndex=i; cancelBtn.style.display="inline";
};

window.cancelEdit=()=>resetForm();

function resetForm(){desc.value=dev.value=solution.value=imageUrls.value="";editIndex=null;cancelBtn.style.display="none"}

function badge(s){return `<span class="badge ${s.replace(" ","").toLowerCase()}">${s}</span>`}

function render(){
  taskBody.innerHTML="";
  tasks.forEach((t,i)=>{
    taskBody.innerHTML+=`
    <tr>
      <td>${t.desc}</td><td>${t.type}</td><td>${badge(t.status)}</td>
      <td>${t.dev}</td><td>${t.solution||"â€”"}</td>
      <td>${t.images.map(img=>`<img src="${img}" class="thumbnail" onclick="openModal('${img}')">`).join("")}</td>
      <td><span class="action-btn" onclick="editTask(${i})">Edit</span> | <span class="action-btn" onclick="deleteTask(${i})">Delete</span></td>
    </tr>`;
  });
  total.innerText=tasks.length;
}

window.openModal=src=>{modalImg.src=src;imageModal.style.display="flex"}
window.closeModal=()=>imageModal.style.display="none"
</script>

</body>
</html>


